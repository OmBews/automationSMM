<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

var _ = require('lodash');
var request = require('request');
var cheerio = require('cheerio');
//var logger = console;

var SELECTOR_REGEX = /([#\.a-zA-Z]+){([^}]*)}/gi;

function toBase64 (str) {
  return (new Buffer(str || '', 'ascii')).toString('base64');
}

/**
 * Scraper
 * @constructor
 * @param {string} url - url to scrape
 * @param {object} [options] - options object
 * @param {string} [options.method=get] - http method to use
 * @param {object} [options.headers] - headers to pass
 * @param {object} [options.auth] - proxy authorizaition
 * @param {string} [options.auth.user] - username
 * @param {string} [options.auth.pass] - password
 * @param {array} [options.selectors=html] - array of selectors to apply to the scraped content.
 * @param {string} [options.extract=html] - extract html or text
 * @param {boolean} [options.decodeEntities=true] - decode html entities?
 * @param {boolean} [options.normalizeWhitespace=true] - remove redundant whitespace
 * @param {boolean} [options.xmlMode=false] - see https://github.com/fb55/htmlparser2/wiki/Parser-options
 * @example
 *    new Scraper('http://somesitetoscrape.com', options);
 *
 */
function Scraper(url, options){

  if(!(this instanceof Scraper)) {
    return new Scraper(url, options);
  }

  if (!_.isString(url)){
    throw new Error("Missing required url param");
  }

  this._config = _.assign({
    method: 'get',
    headers: {
      "User-Agent": 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36',
      accept: 'text/html,application/xhtml+xml'
    },
    selectors: [ 'html' ],
    extract: "html",
    decodeEntities: true,
    normalizeWhitespace: true,
    xmlMode: false
  }, options);
  this._config.url = url;

  if ('auth' in this._config){
    if ("user" in this._config.auth &amp;&amp; "pass" in this._config.auth){
      this._config.headers['proxy-authorization'] = 'Basic ' + toBase64(this._config.auth.user + ':' + this._config.auth.pass);
    }
  }

  //normalize selectors into an array of objects
  var selectors = [];
  var extract = this._config.extract;
  _.forEach(this._config.selectors, function(sel){
    if (_.isString(sel)){
      selectors.push({
        'selector': sel,
        'extract': extract
      });
    }
    else if (_.isPlainObject(sel)){
      if (_.isString(sel.selector)){
        sel.extract = sel.extract || extract;
        selectors.push(sel);
      }
    }
  });
  this._config.selectors = selectors;

  this._content = [];
}

Scraper.prototype = {

  /**
  * Initiate scraping
  */
  scrape: function(){

    var stream;

    var config = {
      "headers": this._config.headers,
      "proxy": this._config.proxy || null,
      "rejectUnauthorized": ("rejectUnauthorized" in this._config ? this._config.rejectUnauthorized : true)
    };
    var req = request.defaults(config);

    var attributes = function($el, attrs){
      var vals = {};
      _.forEach(attrs, function(a){
        vals[a] = $el.attr(a);
      });
      return vals;
    }.bind(this);

    var select = function($){
      return function(s){
        var attrNames;
        var content = [];
        var selector = s.selector;
        var extract = s.extract;
        var matches = SELECTOR_REGEX.exec(selector);
        if (matches &amp;&amp; matches.length > 2){
          selector = matches[1];
          attrNames = matches[2].split(',');
        }
        $(selector).each(function(){
          var $el = $(this);
          var val = {};
          val[extract] = $el[extract]();
          if (attrNames){
            val.attributes = attributes($el, attrNames);
          }
          content.push(val);
        });

        this._content.push({
          'selector': selector,
          'content': content
        });

      }.bind(this);
    }.bind(this);

    var cheerioLoad = function(body, config){
      //logger.log('loading', body);
      return cheerio.load(body, {
        normalizeWhitespace: config.normalizeWhitespace,
        decodeEntities: config.decodeEntities,
        xmlMode: config.xmlMode
      });
    };

    var responseHandler = _.bind(function(err, res, body){
      var $;

      if (res &amp;&amp; res.statusCode >= 200 &amp;&amp; res.statusCode &lt;= 299){
        $ = cheerioLoad(body, this._config);
        _.forEach(this._config.selectors, select($), this);
      }
      //logger.log('emitting', this._content);
      stream.emit('done', err, res ? res.statusCode : undefined, this._content);
    }, this);

    //request returns a stream that supports response, error, and data events
    stream = req[this._config.method].call(this, this._config.url, responseHandler);
    return stream;
  },

  /**
  * get scraped content
  * @returns {array} - content
  */
  get content() {
    return this._content;
  }

};

module.exports = Scraper;


</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Scraper.html">Scraper</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Tue Jun 30 2015 22:01:52 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
